/*******************************************************************
 * File:        os
 * Purpose:     OS interface veneers
 * Author:      Gerph
 * Date:        6 July 2025
 ******************************************************************/

#include <stdlib.h>
#include <stdint.h>
#include "swis.h"

#include "os.h"

/*************************************************** Gerph *********
 Function:      os_confirm
 Description:   Get a Y/N response from the user.
 Parameters:    response-> where to store 'y', 'n' or 27 for response
 Returns:       pointer to error, or NULL if no error
 ******************************************************************/
_kernel_oserror *os_confirm(int *response)
{
    _kernel_oserror *err;
    *response = 0;
    err = _swix(OS_Confirm, _OUT(0), response);
    if (err)
        return err;
    return NULL;
}


/*************************************************** Gerph *********
 Function:      os_readline
 Description:   Call OS_ReadLine for input
 Parameters:    line-> line to read
                len = max length including terminator
 Returns:       1 for success, 0 for failure
 ******************************************************************/
int os_readline(char *line, int len)
{
    _kernel_oserror *err;
    int read;
    uint32_t flags = 0;
#ifdef __riscos64
    err = _swix(OS_ReadLine32, _INR(0, 4)|_OUTR(0, 1), line, len, 32, 128, 0, &flags, &read);
    if (err)
        return 0;
    if (flags)
        goto escape;
    line[read] = '\0';
    return 1;
#else
    err = _swix(OS_ReadLine32, _INR(0, 4)|_OUT(1)|_OUT(_FLAGS), line, len, 32, 128, 0, &read, &flags);
#ifndef ErrorNumber_ModuleBadSWI
#define ErrorNumber_ModuleBadSWI          0x110
#endif
    if (err && err->errnum == ErrorNumber_ModuleBadSWI)
    {
        err = _swix(OS_ReadLine, _INR(0, 4)|_OUT(1)|_OUT(_FLAGS), line, len, 32, 128, 0, &read, &flags);
    }
    if (err)
        return 0;
    if (flags & _C)
        goto escape;
    line[read] = '\0';
    return 1;
#endif

escape:
    return 0;
}
